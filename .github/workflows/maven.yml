name: Jamrik Full-Stack Quality & Security

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # JOB 1: Security Analysis (Static Testing)
  security-scan:
    name: Security & Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v4

      # Scans for leaked API Keys/Secrets in Frontend & Backend
      - name: Secret Scanning
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --debug --only-verified

      # Scans Java code for SQL Injection & Security flaws
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java-kotlin

      - name: Build for Scan
        run: mvn clean compile -DskipTests

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # JOB 2: Functional & Sync Testing
  build-and-test:
    name: Functional & Sync Tests
    runs-on: ubuntu-latest
    needs: security-scan # Only runs if security scan passes
    
    services:
      # Starts a real Postgres 15 database
      db:
        image: postgres:15
        env:
          POSTGRES_DB: jamrikDB
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # RUNS EVERYTHING: Unit tests, Database Sync tests, and Integration tests
      - name: Execute Functional Tests
        run: mvn -B verify --file pom.xml
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/jamrikDB
          SPRING_DATASOURCE_USERNAME: postgres
          SPRING_DATASOURCE_PASSWORD: password
